<div style="width: 100%;">
    <script src="https://unpkg.com/flowbite@1.4.1/dist/flowbite.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tw-elements/dist/css/index.min.css" />

    <div class="flex flex-row-reverse"> 
        <div class="flex justify-center items-center rounded-full w-12 h-12 duration-500 hover:shadow-md hover:shadow-white/50 cursor-pointer mx-4" type="button" data-modal-toggle="post-modal">
            <i class="bi bi-plus-circle "></i>
        </div>
    </div>
    
    <% var pLength = posts.length%>
    <% while(pLength--) {%> 
        <% let post = posts[pLength] %>
        <div id="post-<%= post.id  %>" class="max-w-2xl my-5 mx-auto bg-white rounded-lg">
            <div class="px-6 py-5">
                <div class="flex items-start">
                    <!-- Icon -->
                    <img src="/public/media/favicon.png" style="width: 30px; margin-right: 15px;">
                    <!-- Card content -->
                    <div class="flex-grow truncate">
                        <!-- Card header -->
                        <div class="w-full sm:flex justify-between items-center mb-3">
                            <!-- Title -->
                            <h2 class="text-xl font-bold text-black truncate mb-1 sm:mb-0"> <%= post.pTitle  %>  </h2>
                            <!-- Like and comment buttons -->
                            <p class="mb-2 text-black text-sm"> <%= helper.timeAgo(post.pDate) %>  </p>
                        </div>
                        <!-- Card body -->
                        <div class="whitespace-normal">
                            <!-- Paragraph -->
                            <div class="text-black text-left">
                                <p class="mb-2">
                                    <%= post.pText  %>
                                </p>
                            </div>
                        </div>
                        <div class="whitespace-normal">
                            <!-- Paragraph -->
                            <div class="text-black text-left text-base w-full sm:flex justify-between items-center ">
                                <div class="flex">
                                    <i class="bi bi-person-circle mr-2"></i>
                                    <p class="mb-2"><%= post.pAuthor  %> </p>
                                </div>
    
                                <div class="flex-shrink-0 flex items-center space-x-3 sm:ml-2">
                                    <button onclick="like('<%- post.id  %>')" class="flex items-center text-left text-sm font-medium text-black hover:text-gray-500 group focus:outline-none focus-visible:border-b focus-visible:border-indigo-100">
                                        <svg class="w-4 h-4 flex-shrink-0 mr-2 fill-current text-black group-hover:text-gray-500"  width="16" height="16" fill="currentColor" class="bi bi-hand-thumbs-up-fill" viewBox="0 0 16 16">
                                            <path d="M6.956 1.745C7.021.81 7.908.087 8.864.325l.261.066c.463.116.874.456 1.012.965.22.816.533 2.511.062 4.51a9.84 9.84 0 0 1 .443-.051c.713-.065 1.669-.072 2.516.21.518.173.994.681 1.2 1.273.184.532.16 1.162-.234 1.733.058.119.103.242.138.363.077.27.113.567.113.856 0 .289-.036.586-.113.856-.039.135-.09.273-.16.404.169.387.107.819-.003 1.148a3.163 3.163 0 0 1-.488.901c.054.152.076.312.076.465 0 .305-.089.625-.253.912C13.1 15.522 12.437 16 11.5 16H8c-.605 0-1.07-.081-1.466-.218a4.82 4.82 0 0 1-.97-.484l-.048-.03c-.504-.307-.999-.609-2.068-.722C2.682 14.464 2 13.846 2 13V9c0-.85.685-1.432 1.357-1.615.849-.232 1.574-.787 2.132-1.41.56-.627.914-1.28 1.039-1.639.199-.575.356-1.539.428-2.59z"/>
                                        </svg>
                                        <span id="plikes<%- post.id  %>"><%= post.pLikes.length  %></span>
                                    </button>
                                    <button onclick="dislike('<%- post.id  %>')" class="flex items-center text-left text-sm font-medium text-black hover:text-gray-500 group focus:outline-none focus-visible:border-b focus-visible:border-indigo-100">
                                        <svg class="w-4 h-4 flex-shrink-0 mr-2 fill-current text-black group-hover:text-gray-500" width="16" height="16" fill="currentColor" class="bi bi-hand-thumbs-down-fill" viewBox="0 0 16 16">
                                            <path d="M6.956 14.534c.065.936.952 1.659 1.908 1.42l.261-.065a1.378 1.378 0 0 0 1.012-.965c.22-.816.533-2.512.062-4.51.136.02.285.037.443.051.713.065 1.669.071 2.516-.211.518-.173.994-.68 1.2-1.272a1.896 1.896 0 0 0-.234-1.734c.058-.118.103-.242.138-.362.077-.27.113-.568.113-.856 0-.29-.036-.586-.113-.857a2.094 2.094 0 0 0-.16-.403c.169-.387.107-.82-.003-1.149a3.162 3.162 0 0 0-.488-.9c.054-.153.076-.313.076-.465a1.86 1.86 0 0 0-.253-.912C13.1.757 12.437.28 11.5.28H8c-.605 0-1.07.08-1.466.217a4.823 4.823 0 0 0-.97.485l-.048.029c-.504.308-.999.61-2.068.723C2.682 1.815 2 2.434 2 3.279v4c0 .851.685 1.433 1.357 1.616.849.232 1.574.787 2.132 1.41.56.626.914 1.28 1.039 1.638.199.575.356 1.54.428 2.591z"/>
                                        </svg>
                                        <span id="pdislikes<%- post.id  %>"><%= post.pDislikes.length  %></span>
                                    </button>
                                    <button data-bs-toggle="modal" data-bs-target="#exampleModalScrollable<%= post.id  %>" type="submit" class="flex items-center text-left text-sm font-medium text-black hover:text-gray-500 group focus:outline-none focus-visible:border-b focus-visible:border-indigo-100">
                                        <svg class="w-4 h-4 flex-shrink-0 mr-2 fill-current text-black group-hover:text-gray-500" width="16" height="16" fill="currentColor" class="bi bi-chat-fill" viewBox="0 0 16 16">
                                            <path d="M8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6-.097 1.016-.417 2.13-.771 2.966-.079.186.074.394.273.362 2.256-.37 3.597-.938 4.18-1.234A9.06 9.06 0 0 0 8 15z"/>
                                            </svg>
                                        <span><%= post.pComments.length  %></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade fixed top-0 left-0 hidden w-full h-full outline-none overflow-x-hidden overflow-y-auto" id="exampleModalScrollable<%= post.id  %>" tabindex="-1" aria-labelledby="exampleModalScrollableLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-scrollable relative w-auto  pointer-events-none" >
                    <div class="modal-content border-none shadow-lg relative flex flex-col w-full pointer-events-auto bg-white bg-clip-padding rounded-md outline-none text-current">
                        
                        <div class="modal-header flex flex-shrink-0 items-center justify-between p-4 border-b border-gray-200 rounded-t-md">
                            <h3 class="py-4 text-xl font-medium text-black"> <%= post.pAuthor  %>'s post replys </h3>
                            <button type="button" class="btn-close box-content w-4 h-4 p-1 text-black border-none rounded-none opacity-50 focus:shadow-none focus:outline-none focus:opacity-100 hover:text-black hover:opacity-75 hover:no-underline"
                                data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        
                        <div class="modal-body relative p-4">
                            <% for(var comment of post.pComments) {%> 
                                <div class="max-w-2xl my-5 mx-auto bg-white hover:shadow-lg duration-300 rounded-lg">
                                    <div class="px-6 py-5">
                                        <div class="flex items-start">
                                            <!-- Icon -->
                                            <img src="/public/media/favicon.png" style="width: 30px; margin-right: 15px;">
                                            <!-- Card content -->
                                            <div class="flex-grow truncate">
                                                <!-- Card header -->
                                                <div class="w-full sm:flex justify-between items-center mb-3">
                                                    <!-- Like and comment buttons -->
                                                    <div class="text-black text-left">
                                                        <p class="mb-2">
                                                            <%- comment.cText.replace(/\r\n/g, '<br/>') %>
                                                        </p>
                                                    </div>
                                                </div>
                                                <div class="whitespace-normal">
                                                    <!-- Paragraph -->
                                                    <div class="text-black text-left text-base w-full sm:flex justify-between items-center ">
                                                        <div class="flex">
                                                            <i class="bi bi-person-circle mr-2"></i>
                                                            <p class="mb-2"><%= comment.cAuthor  %></p>
                                                        </div>
                                                        <p class="mb-2 text-black text-sm">  <%= helper.timeAgo(comment.cDate) %> </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <% } %>
    
                            <form class="px-6 pb-4 space-y-6 lg:px-8 sm:pb-6 xl:pb-8" method="POST" action="/va-holder-reply-post/<%= post.id  %>" id="replyform<%= post.id  %>">
                                <h5 class="py-2 text-xl text-sm text-black text-left"> Reply to post </h5>
                                <textarea class="bg-gray-50 border border-gray-300 text-black text-sm rounded-xl focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" name="text" form="replyform<%= post.id  %>" placeholder="Reply" style="resize:none" rows="10"></textarea>
                                <div class="flex flex-row-reverse">
                                    <button type="submit" class="text-white bg-black hover:bg-white hover:text-black border border-black font-medium rounded-xl text-sm px-5 py-2.5 text-center duration-300" data-bs-dismiss="modal"> Reply </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <% } %>


    <!-- Post modal -->
    <div id="post-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 w-full md:inset-0 h-modal md:h-full">
        <div class="relative p-4 w-full max-w-4xl h-full md:h-auto">
            <!-- Modal content -->
            <div class="relative bg-white rounded-lg shadow">
                <div class="flex justify-end p-2">
                    <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" data-modal-toggle="post-modal">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>  
                    </button>
                </div>
                <form class="px-6 pb-4 space-y-6 lg:px-8 sm:pb-6 xl:pb-8" method="post" action="/va-holder-post" id="postform">
                    <h3 class="py-4 text-xl font-medium text-black"> Post </h3>
                    <input type="text" name="title" id="name" class="bg-gray-50 border border-gray-300 text-black text-sm rounded-xl focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Title" required>
                    <textarea class="bg-gray-50 border border-gray-300 text-black text-sm rounded-xl focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" name="text" form="postform" placeholder="Text" style="resize:none" rows="10"></textarea>
                    <div class="flex flex-row-reverse">
                        <button type="submit" class="text-white bg-black hover:bg-white hover:text-black border border-black font-medium rounded-xl text-sm px-5 py-2.5 text-center duration-300"> Post </button>
                    </div>
                </form>
            </div>
        </div>
    </div> 
</div>

<script src="https://cdn.jsdelivr.net/npm/tw-elements/dist/js/index.min.js"></script>

<script>
    const like = (pid) => {
        fetch(`/va-holder-like-post/${pid}`, {method: 'POST', headers: {Accept: 'application/json'}})
        .then(response => response.json())
        .then(response => 
            {
                if(response.liked && !response.disliked){
                    document.getElementById(`plikes${pid}`).innerHTML = parseInt(document.getElementById(`plikes${pid}`).innerHTML) - 1;
                }else if(!response.liked && !response.disliked){
                    document.getElementById(`plikes${pid}`).innerHTML = parseInt(document.getElementById(`plikes${pid}`).innerHTML) + 1;
                }else{
                    showNotification("Already disliked this post");
                    console.log(" Already disliked ");
                }
            }
        )
        .catch(err => {
            console.log("Error: " + err);
        });
    };

    const dislike = (pid) => {
        fetch(`/va-holder-dislike-post/${pid}`, {method: 'POST', headers: {Accept: 'application/json'}})
        .then(response => response.json())
        .then(response => 
            {
                if(!response.liked && response.disliked){
                    document.getElementById(`pdislikes${pid}`).innerHTML = parseInt(document.getElementById(`pdislikes${pid}`).innerHTML) - 1;
                }else if(!response.liked && !response.disliked){
                    document.getElementById(`pdislikes${pid}`).innerHTML = parseInt(document.getElementById(`pdislikes${pid}`).innerHTML) + 1;
                }else{
                    showNotification("Already liked this post");
                    console.log(" Already liked ");
                }
            }
        )
        .catch(err => {
            console.log("Error: " + err);
        });
    };
</script>

